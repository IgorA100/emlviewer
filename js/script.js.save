$(document).ready(function(){
	if($("#filestable").length) { 
		$('#filestable').bind('DOMSubtreeModified', function(e) {
			$(".name[href$='.eml']").unbind();
			var emlFiles = $("#filestable tr .name[href$='.eml']");
			if (emlFiles.length > 0) {
				$(".name[href$='.eml']").on('click', function(e){
					bringInSidebar();
					displayParsedEmail($(this).attr('href'));				});
			}
		});
	}
});

function bringInSidebar() {
	var defaultHtml = '<a class="close icon-close" href="#"></a>';
	defaultHtml += '<div class="mail-content" style="text-align: center; margin-top: 30px;">Preparing preview... please wait.</div>';

	$("#app-sidebar").remove();
	$("#app-content").after('<div id="app-sidebar"></div>');
	$("#app-sidebar").html(defaultHtml);
	$(".icon-close").unbind();
	$(".icon-close").click(function(){ $("#app-sidebar").remove(); });
}


function displayParsedEmail(emailFile) {
	var file = '';

	$.ajax({
		async: false,
		method: 'GET',
		url: emailFile,
		success: function(response) {
			file = response;
		}
	});

	if (file.length) {
		$.ajax({
			async: false,
			method: 'POST',
			url: '/apps/emlviewer/ajax/emlparse.php',
			data: 'eml_file='+file,
			success: function(response) {
				$(".mail-content").html(response);
			}
		});
	} else {
		$(".mail-content").text("Error retrieving the eml file. Try again later.");
	}
}
